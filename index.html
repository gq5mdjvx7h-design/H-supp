lÃ <!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Compteur Heures Sup â€“ AUTO (Report + dÃ©tail majorations)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* PARTIE 1 â€” configuration repliable */
.section summary{
  cursor:pointer;
  font-weight:bold;
  background:#eeeeee;
  padding:10px;
  border-radius:8px;
  margin-bottom:10px;
}

.section[open] summary{
  background:#e0e0e0;
}

/* PARTIE 3 â€” dÃ©tails repliables */
.calc-details summary{
  cursor:pointer;
  font-weight:bold;
  background:#e3f2fd;
  padding:8px;
  border-radius:6px;
  margin-bottom:8px;
}

.calc-details[open] summary{
  background:#bbdefb;
}
body{font-family:Arial,sans-serif;background:#f2f2f2;padding:15px}
h1,h2{text-align:center}
.config,.totaux{background:#fff;padding:15px;border-radius:8px;max-width:900px;margin:15px auto}
.calendar-wrapper{max-width:900px;margin:20px auto}
.weekdays,.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
.weekday{text-align:center;font-weight:bold;background:#ddd;padding:8px 0;border-radius:6px}
.day{
  background:#fff;
  padding:6px;
  border-radius:6px;
  cursor:pointer;
  text-align:center;
  height:80px;              /* ğŸ”’ taille fixe */
  box-sizing:border-box;
  overflow:hidden;          /* empÃªche lâ€™agrandissement */
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
  .day small{
  font-size:11px;
  line-height:1.1;
  white-space:nowrap;
}
.day.in-period{border:2px solid #2e7d32;background:#e8f5e9}
.month-nav{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
button,input,select,textarea{width:100%;padding:8px;margin:5px 0}
.popup{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10}
.popup-content{background:#fff;padding:20px;width:380px;border-radius:10px}
.breakdown{background:#f9f9f9;padding:10px;border-radius:6px;margin-top:10px;font-size:14px}
.day.today{outline:3px solid #ff9800;box-shadow:0 0 6px rgba(255,152,0,.8)}
</style>
</head>

<body>

<h1>Compteur Heures Sup</h1>

<p style="text-align:center">
  Exercice : <b id="activeYearLabel"></b>
  <button onclick="switchYear()">ğŸ“ Changer</button>
</p>


<details class="section">
  <summary>ğŸ”§ Configuration</summary>

  <div class="config">

    <label><b>Date de dÃ©but dâ€™exercice</b></label>
    <input type="date" id="exerciseStartInput">

    <div id="rateContainer"></div>

    <hr>
    <button onclick="exportJSON()">â¬‡ï¸ Exporter (.json)</button>
    <button onclick="importJSON()">â¬†ï¸ Importer (.json)</button>
    <button onclick="exportMonthlyPDF()">ğŸ“„ Export PDF du mois</button>

    <hr>
    <label>Date de clÃ´ture annuelle</label>
    <input type="date" id="annualDateInput">

    <hr>
    <h2>Jours fÃ©riÃ©s</h2>
    <button onclick="importFeries()">ğŸ‡«ğŸ‡· Importer les jours fÃ©riÃ©s officiels</button>

  </div>
</details>

<div class="calendar-wrapper main-zone">
<div class="month-nav">
<select id="monthSelect"></select>
<select id="yearSelect"></select>
</div>

<div class="weekdays">
<div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div>
<div class="weekday">Jeu</div><div class="weekday">Ven</div><div class="weekday">Sam</div><div class="weekday">Dim</div>
</div>
<div class="calendar" id="calendar"></div>
</div>

<div class="totaux main-zone" id="totaux"></div>

<div class="popup" id="popup">
<div class="popup-content">
<h3 id="popupDate"></h3>

<fieldset>
  <legend>â• Heures supplÃ©mentaires</legend>
  <button onclick="addExtra(0.25)">+15 min</button>
  <button onclick="addExtra(0.5)">+30 min</button>
  <button onclick="addExtra(1)">+1 h</button>
  <button onclick="addExtra(2)">+2 h</button>
  <input id="manualExtra" type="number" step="0.25">
</fieldset>

<fieldset>
  <legend>â– RÃ©cupÃ©ration</legend>
  <button onclick="addRecup(0.25)">-15 min</button>
  <button onclick="addRecup(0.5)">-30 min</button>
  <button onclick="addRecup(1)">-1 h</button>
  <input id="manualRecup" type="number" step="0.25">
</fieldset>

<fieldset>
  <legend>âŒ Absence</legend>
  <label>
    <input type="checkbox" id="isAbsent"> Jour d'absence
  </label>
  <input id="absentHours" type="number" step="0.25">
</fieldset>

<button onclick="saveManual()">Enregistrer</button>
<button onclick="closePopup()">Fermer</button>
</div>
</div>

<div class="popup" id="popupJSON">
<div class="popup-content">
<h3 id="jsonTitle"></h3>
<textarea id="jsonArea" style="width:100%;height:200px"></textarea>
<button onclick="confirmImportJSON()">Importer</button>
<button onclick="closeJSONPopup()">Fermer</button>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>

// ===== MULTI-ANNÃ‰E =====
let currentSuffix = localStorage.getItem("ACTIVE_YEAR_SUFFIX") || new Date().getFullYear();
document.getElementById("activeYearLabel").textContent = currentSuffix;

function switchYear(){
  const res = prompt("AnnÃ©e / exercice :", currentSuffix);
  if(res && res !== currentSuffix){
    localStorage.setItem("ACTIVE_YEAR_SUFFIX", res);
    location.reload();
  }
}

// ===== STOCKAGE DYNAMIQUE =====
const STORAGE = {
  data: "DATA_REPORT_" + currentSuffix,
  annualDate: "ANNUAL_DATE_" + currentSuffix,
  specialDays: "SPECIAL_DAYS_" + currentSuffix,
  exerciseStart: "EXERCISE_START_" + currentSuffix
};

// ===== DONNÃ‰ES =====
let data = JSON.parse(localStorage.getItem(STORAGE.data)) || {};
let annualDate = localStorage.getItem(STORAGE.annualDate) || "";
let annualRate = 10;
let specialDays = JSON.parse(localStorage.getItem(STORAGE.specialDays)) || {};
let exerciseStart = localStorage.getItem(STORAGE.exerciseStart) || "";

// OPTION : autoriser la rÃ©cup mÃªme sans heures sup le mÃªme jour
const ALLOW_RECUP_FREE = true;
const months=["Janvier","FÃ©vrier","Mars","Avril","Mai","Juin","Juillet","AoÃ»t","Septembre","Octobre","Novembre","DÃ©cembre"]
const monthSelect=document.getElementById("monthSelect")
const yearSelect=document.getElementById("yearSelect")
const calendar=document.getElementById("calendar")
const totaux=document.getElementById("totaux")
const popup = document.getElementById("popup")
const popupDate = document.getElementById("popupDate")
const manualExtra = document.getElementById("manualExtra")
const manualRecup = document.getElementById("manualRecup")
const isAbsent = document.getElementById("isAbsent")
const absentHours = document.getElementById("absentHours")

const popupJSON = document.getElementById("popupJSON")
const jsonTitle = document.getElementById("jsonTitle")
const jsonArea = document.getElementById("jsonArea")
  
let view=new Date()
let viewMonth=view.getMonth()
let viewYear=view.getFullYear()
let selectedDate=""

// ğŸ”’ ClÃ© de date locale (Ã©vite les bugs UTC / changement dâ€™annÃ©e)
function dateKeyLocal(d){
  const y = d.getFullYear()
  const m = String(d.getMonth() + 1).padStart(2, "0")
  const day = String(d.getDate()).padStart(2, "0")
  return `${y}-${m}-${day}`
}

function getBaseStartDate(){
  if(!exerciseStart){
    alert("âš ï¸ Merci de dÃ©finir la date de dÃ©but dâ€™exercice");
    throw new Error("Exercise start not defined");
  }
  return new Date(exerciseStart);
}

function initSelectors(){
monthSelect.innerHTML=""
months.forEach((m,i)=>{
const o=document.createElement("option")
o.value=i;o.textContent=m
if(i===viewMonth)o.selected=true
monthSelect.appendChild(o)
})
yearSelect.innerHTML=""
for(let y=viewYear-2;y<=2050;y++){
const o=document.createElement("option")
o.value=y;o.textContent=y
if(y===viewYear)o.selected=true
yearSelect.appendChild(o)
}
}

function generateCalendar(){
calendar.innerHTML=""
const firstDay = new Date(viewYear, viewMonth, 1).getDay()
const offset = firstDay === 0 ? 6 : firstDay - 1
const days=new Date(viewYear,viewMonth+1,0).getDate()
for(let i=0;i<offset;i++)calendar.appendChild(document.createElement("div"))
for(let d=1;d<=days;d++){
const key=`${viewYear}-${String(viewMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`
const div=document.createElement("div")
div.className="day"
const day = data[key] || { extra:0, recup:0, absent:0 }
let html = `<strong>${d}</strong>`

if(day.extra){
  html += `<small style="color:#1976d2">+${day.extra}h</small>`
}

if(day.recup){
  html += `<small style="color:#ef6c00">-${day.recup}h</small>`
}

if(day.absent){
  if(specialDays[key] === "ferie"){
    html += `<small style="color:#0d47a1;font-weight:bold">ğŸŒ FÃ©riÃ©</small>`
    div.style.background = "#e3f2fd"
    div.style.border = "2px dashed #1976d2"
  }else{
    html += `<small style="color:#c62828;font-weight:bold">ABS ${day.absent}h</small>`
    div.style.background = "#ffebee"
    div.style.border = "2px solid #c62828"
  }
}

div.innerHTML = html
if(key===new Date().toISOString().slice(0,10))div.classList.add("today")
div.onclick=()=>openPopup(key)
calendar.appendChild(div)
}
}

function calculate(){
let weeks={}, absences={}, totalRecup=0, details=[]
let h25=0,h50=0
Object.entries(weeks).forEach(([week,extra])=>{
const absent = absences[week]||0
    const base = Math.max(0,35-absent)
    const total=base+extra
let w25=0,w50=0
if(total > 35) {
  w25 = Math.min(total - 35, 8)
}

if(total > 43) {
  w50 = total - 43
}
h25+=w25; h50+=w50
details.push(`Semaine du ${new Date(week).toLocaleDateString()} : Base ${base}h (Abs ${absent}h) â†’ ${w25}h Ã  25% / ${w50}h Ã  50%`)
})
const brut25 = h25*1.25
const brut50 = h50*1.5
totaux.innerHTML = `
<details class="calc-details">
  <summary>ğŸ“Š DÃ©tails des calculs</summary>
  <div class="breakdown">
    ${details.join("<br>")}
    <hr>
    25% : ${h25}h Ã— 1,25 = ${brut25.toFixed(2)} h<br>
    50% : ${h50}h Ã— 1,50 = ${brut50.toFixed(2)} h<br>
    Report prÃ©cÃ©dent : ${reportPrev.toFixed(2)} h
  </div>
</details>

<hr>

<b>Solde brut :</b> ${brut.toFixed(2)} h<br>
RÃ©cup : ${totalRecup.toFixed(2)} h<br>
<b>Solde net :</b> ${net.toFixed(2)} h
`

// --- LOGIQUE DE CLÃ”TURE ANNUELLE ---
const rateContainer = document.getElementById("rateContainer");
rateContainer.innerHTML = "";

// --- CALCUL ABSENCES ANNÃ‰E ---
let annualAbsHours = 0
let annualAbsDays = 0
let annualFerieDays = 0
let annualFerieHours = 0

const rate = annualRate || 10;
  const paiement = net * rate;

totaux.innerHTML += `
  <hr>
  <div style="background:#e8f5e9;padding:15px;border:2px solid #2e7d32;border-radius:8px;">
    <h3 style="margin:0;color:#2e7d32;">ğŸ¯ ClÃ´ture Annuelle</h3>

    <b>Solde Ã  liquider :</b> ${net.toFixed(2)} h<br>
    <b>Paiement (${rate}â‚¬/h) :</b> ${paiement.toFixed(2)} â‚¬<br>

    <hr>

<b>ğŸ“Œ RÃ©capitulatif annuel (${currentSuffix})</b><br>

âŒ Absences :<br>
â€¢ ${annualAbsDays} jour(s)<br>
â€¢ ${annualAbsHours.toFixed(2)} h<br><br>

ğŸŒ Jours fÃ©riÃ©s :<br>
â€¢ ${annualFerieDays} jour(s)<br>
â€¢ ${annualFerieHours.toFixed(2)} h
  </div>`;
}

}

function openPopup(date){
  
selectedDate=date
const d=data[date]||{extra:0,recup:0,absent:0}
popupDate.textContent=date
manualExtra.value=d.extra
manualRecup.value=d.recup
  absentHours.value=d.absent||0
  isAbsent.checked=(d.absent||0)>0
document.getElementById("popup").style.display="flex"
}

function closePopup(){document.getElementById("popup").style.display="none";update()}

function addExtra(h){
  if(!data[selectedDate]) data[selectedDate]={extra:0,recup:0}
  data[selectedDate].extra=Math.round((data[selectedDate].extra+h)*4)/4
  save();closePopup()
}

function addRecup(h){
  if(!data[selectedDate]) data[selectedDate]={extra:0,recup:0}
  const newVal = Math.round((data[selectedDate].recup+h)*4)/4
  data[selectedDate].recup = ALLOW_RECUP_FREE ? newVal : Math.min(newVal, data[selectedDate].extra)
  save();closePopup()
}

function saveManual(){
  const extra=Math.max(0,Number(manualExtra.value)||0)
  const recup=Math.max(0,Number(manualRecup.value)||0)
  const absent = isAbsent.checked ? Math.max(0,Number(absentHours.value)||0) : 0
  data[selectedDate]={
    extra:Math.round(extra*4)/4,
    recup: ALLOW_RECUP_FREE ? Math.round(recup*4)/4 : Math.min(Math.round(recup*4)/4, extra),
    absent:Math.round(absent*4)/4
  }
  save();closePopup()
}

function save(){ localStorage.setItem(STORAGE.data,JSON.stringify(data)) }

function isIOS(){return /iPad|iPhone|iPod/.test(navigator.userAgent)}



function importJSON(){
if(isIOS()){
jsonTitle.textContent = "Collez le texte JSON (Import)"
jsonArea.value = ""
popupJSON.style.display = "flex"
}else{
const input = document.createElement("input")
input.type = "file"
input.accept = ".json"
input.onchange = e => {
const reader = new FileReader()
reader.onload = () => loadJSON(reader.result)
reader.readAsText(e.target.files[0])
}
input.click()
}
}

function confirmImportJSON(){loadJSON(jsonArea.value);closeJSONPopup()}


function closeJSONPopup(){popupJSON.style.display = "none"}

async function importFeries(){
  const year = currentSuffix

  if(!confirm("Importer les jours fÃ©riÃ©s officiels pour " + year + " ?")) return

  try{
    const res = await fetch(
      `https://calendrier.api.gouv.fr/jours-feries/metropole/${year}.json`
    )
    const feries = await res.json()

    Object.keys(feries).forEach(date=>{
      // ne pas Ã©craser une valeur existante
      if(!specialDays[date]){
        specialDays[date] = "ferie"
      }
      // crÃ©er le jour seulement sâ€™il nâ€™existe pas
if(!data[date]){
  data[date] = { extra:0, recup:0, absent:7 }
}
// sinon : ON NE TOUCHE Ã€ RIEN
    })

    localStorage.setItem(STORAGE.specialDays, JSON.stringify(specialDays))
    localStorage.setItem(STORAGE.data, JSON.stringify(data))

    update()
    alert("âœ… Jours fÃ©riÃ©s importÃ©s")
  }catch(e){
    alert("âŒ Impossible dâ€™importer les jours fÃ©riÃ©s")
  }
}
function update(){generateCalendar();calculate();autoBackup()}

monthSelect.onchange=()=>{viewMonth=+monthSelect.value;generateCalendar()}
yearSelect.onchange=()=>{viewYear=+yearSelect.value;generateCalendar()}


const annualDateInput = document.getElementById("annualDateInput");
annualDateInput.value = annualDate;
annualDateInput.onchange = ()=>{
  annualDate = annualDateInput.value;
  localStorage.setItem(STORAGE.annualDate, annualDate);
};
const exerciseStartInput = document.getElementById("exerciseStartInput");
exerciseStartInput.value = exerciseStart;

exerciseStartInput.onchange = ()=>{
  exerciseStart = exerciseStartInput.value;
  localStorage.setItem(STORAGE.exerciseStart, exerciseStart);
  
  
  // ===== FONCTION DE VÃ‰RIFICATION DU MOIS EXACT =====
function exportMonthlyPDF(){
  const { jsPDF } = window.jspdf
  const pdf = new jsPDF()

  const monthName = months[viewMonth]
  const title = `Heures supplÃ©mentaires â€“ ${monthName} ${viewYear}`

  let y = 15
  pdf.setFontSize(14)
  pdf.text(title, 10, y)

  y += 10
  pdf.setFontSize(10)

  let totalExtra = 0
  let totalRecup = 0
  let totalAbs = 0
  Object.entries(data).forEach(([date, v])=>{
  const d = new Date(date)

  // uniquement le mois affichÃ©
  if(
    d.getFullYear() === viewYear &&
    d.getMonth() === viewMonth
  ){
    totalExtra += v.extra || 0
    totalRecup += v.recup || 0
    totalAbs += v.absent || 0
  }
})
  y += 5
  pdf.text(`Total heures sup : ${totalExtra.toFixed(2)} h`, 10, y)
  y += 6
  pdf.text(`Total rÃ©cupÃ©ration : ${totalRecup.toFixed(2)} h`, 10, y)
  y += 6
  pdf.text(`Total absences : ${totalAbs.toFixed(2)} h`, 10, y)

  pdf.save(`heures_sup_${monthName}_${viewYear}.
  
function showToast(){
  const toast = document.getElementById("toast")
  if(!toast) return

  toast.style.opacity = "1"
  setTimeout(() => {
    toast.style.opacity = "0"
  }, 3000)
}
</script>
<div id="toast" style="
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#323232;
  color:#fff;
  padding:10px 16px;
  border-radius:20px;
  font-size:14px;
  opacity:0;
  pointer-events:none;
  transition:opacity .4s;
  z-index:9999;
">
  ğŸ•› Nouvelle pÃ©riode activÃ©e automatiquement
</div>

</body>
</html>
