<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Compteur Heures Sup ‚Äì AUTO (Report + d√©tail majorations)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* PARTIE 1 ‚Äî configuration repliable */
.section summary{
  cursor:pointer;
  font-weight:bold;
  background:#eeeeee;
  padding:10px;
  border-radius:8px;
  margin-bottom:10px;
}

.section[open] summary{
  background:#e0e0e0;
}

/* PARTIE 3 ‚Äî d√©tails repliables */
.calc-details summary{
  cursor:pointer;
  font-weight:bold;
  background:#e3f2fd;
  padding:8px;
  border-radius:6px;
  margin-bottom:8px;
}

.calc-details[open] summary{
  background:#bbdefb;
}
body{font-family:Arial,sans-serif;background:#f2f2f2;padding:15px}
h1,h2{text-align:center}
.config,.totaux{background:#fff;padding:15px;border-radius:8px;max-width:900px;margin:15px auto}
.calendar-wrapper{max-width:900px;margin:20px auto}
.weekdays,.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
.weekday{text-align:center;font-weight:bold;background:#ddd;padding:8px 0;border-radius:6px}
.day{
  background:#fff;
  padding:6px;
  border-radius:6px;
  cursor:pointer;
  text-align:center;
  height:80px;              /* üîí taille fixe */
  box-sizing:border-box;
  overflow:hidden;          /* emp√™che l‚Äôagrandissement */
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
  .day small{
  font-size:11px;
  line-height:1.1;
  white-space:nowrap;
}
.day.in-period{border:2px solid #2e7d32;background:#e8f5e9}
.month-nav{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
button,input,select,textarea{width:100%;padding:8px;margin:5px 0}
.popup{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:10}
.popup-content{background:#fff;padding:20px;width:380px;border-radius:10px}
.breakdown{background:#f9f9f9;padding:10px;border-radius:6px;margin-top:10px;font-size:14px}
.day.today{outline:3px solid #ff9800;box-shadow:0 0 6px rgba(255,152,0,.8)}
</style>
</head>


<body>

<h1>Compteur Heures Sup</h1>

<p style="text-align:center">
  Exercice : <b id="activeYearLabel"></b>
  <button onclick="switchYear()">üìÅ Changer</button>
</p>


<details class="section">
  <summary>üîß Configuration</summary>

  <div class="config">

    <label><b>Date de d√©but d‚Äôexercice</b></label>
    <input type="date" id="exerciseStartInput">

    <h2>P√©riode comptable</h2>
    <button onclick="openClosures()">üìÖ D√©finir / modifier les cl√¥tures</button>
    <select id="periodSelect"></select>
    <p id="periodInfo"></p>

    <button onclick="toggleLock()">üîí Verrouiller / üîì D√©verrouiller la p√©riode</button>
    <p id="lockInfo"></p>

    <div id="rateContainer"></div>

    <hr>
    <button onclick="exportJSON()">‚¨áÔ∏è Exporter (.json)</button>
    <button onclick="importJSON()">‚¨ÜÔ∏è Importer (.json)</button>
    <button onclick="exportMonthlyPDF()">üìÑ Export PDF du mois</button>

    <hr>
    <label>Date de cl√¥ture annuelle</label>
    <input type="date" id="annualDateInput">

    <hr>
    <h2>Jours f√©ri√©s</h2>
    <button onclick="importFeries()">üá´üá∑ Importer les jours f√©ri√©s officiels</button>

  </div>
</details>

<div class="calendar-wrapper main-zone">
<div class="month-nav">
<select id="monthSelect"></select>
<select id="yearSelect"></select>
</div>

<div class="weekdays">
<div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div>
<div class="weekday">Jeu</div><div class="weekday">Ven</div><div class="weekday">Sam</div><div class="weekday">Dim</div>
</div>
<div class="calendar" id="calendar"></div>
</div>

<div class="totaux main-zone" id="totaux"></div>

<div class="popup" id="popup">
<div class="popup-content">
<h3 id="popupDate"></h3>

<fieldset>
  <legend>‚ûï Heures suppl√©mentaires</legend>
  <button onclick="addExtra(0.25)">+15 min</button>
  <button onclick="addExtra(0.5)">+30 min</button>
  <button onclick="addExtra(1)">+1 h</button>
  <button onclick="addExtra(2)">+2 h</button>
  <input id="manualExtra" type="number" step="0.25">
</fieldset>

<fieldset>
  <legend>‚ûñ R√©cup√©ration</legend>
  <button onclick="addRecup(0.25)">-15 min</button>
  <button onclick="addRecup(0.5)">-30 min</button>
  <button onclick="addRecup(1)">-1 h</button>
  <input id="manualRecup" type="number" step="0.25">
</fieldset>

<fieldset>
  <legend>‚ùå Absence</legend>
  <label>
    <input type="checkbox" id="isAbsent"> Jour d'absence
  </label>
  <input id="absentHours" type="number" step="0.25">
</fieldset>

<button onclick="saveManual()">Enregistrer</button>
<button onclick="closePopup()">Fermer</button>
</div>
</div>

<div class="popup" id="popupJSON">
<div class="popup-content">
<h3 id="jsonTitle"></h3>
<textarea id="jsonArea" style="width:100%;height:200px"></textarea>
<button onclick="confirmImportJSON()">Importer</button>
<button onclick="closeJSONPopup()">Fermer</button>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let midnightTimer = null
function autoSwitchPeriodAtMidnight(){
  const now = new Date()

  const nextMidnight = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate() + 1,
    0, 0, 0, 0
  )

  const delay = nextMidnight - now

  // üîí S√©curisation : un seul timer actif
  if(midnightTimer){
    clearTimeout(midnightTimer)
  }

  midnightTimer = setTimeout(() => {
    buildPeriods()
    update()
    showToast()
    autoSwitchPeriodAtMidnight() // relance pour la nuit suivante
  }, delay)
}

// ===== MULTI-ANN√âE =====
let currentSuffix = localStorage.getItem("ACTIVE_YEAR_SUFFIX") || new Date().getFullYear();
document.getElementById("activeYearLabel").textContent = currentSuffix;

function switchYear(){
  openYearsPopup()
}
function openYearsPopup(){
  const box = document.getElementById("yearsList")
  box.innerHTML = ""

  const years = getExistingYears()

  if(years.length === 0){
    box.innerHTML = "<i>Aucun exercice existant</i>"
  } else {
    years.forEach(y=>{
      const btn = document.createElement("button")
      btn.textContent = y + (String(y) === String(currentSuffix) ? " (actif)" : "")
      btn.onclick = () => {
        localStorage.setItem("ACTIVE_YEAR_SUFFIX", y)
        location.reload()
      }
      box.appendChild(btn)
    })
  }

  document.getElementById("popupYears").style.display = "flex"
}

function closeYearsPopup(){
  document.getElementById("popupYears").style.display = "none"
}

function confirmSwitchYear(){
  const val = document.getElementById("newYearInput").value
  if(!val) return

  // üîπ Initialisation minimale si l'exercice n'existe pas
  const baseKey = "DATA_REPORT_" + val
  if(!localStorage.getItem(baseKey)){
    localStorage.setItem(baseKey, JSON.stringify({}))
    localStorage.setItem("CLOSURES_REPORT_" + val, JSON.stringify([]))
    localStorage.setItem("REPORTS_REPORT_" + val, JSON.stringify({}))
    localStorage.setItem("LOCKS_REPORT_" + val, JSON.stringify({}))
    localStorage.setItem("PERIOD_META_REPORT_" + val, JSON.stringify({}))
  }

  localStorage.setItem("ACTIVE_YEAR_SUFFIX", val)
  location.reload()
}

function getExistingYears(){
  const years = new Set()

  for(let i=0; i<localStorage.length; i++){
    const key = localStorage.key(i)
    if(key.startsWith("DATA_REPORT_")){
      years.add(key.replace("DATA_REPORT_", ""))
    }
  }

  return Array.from(years).sort()
}
// ===== STOCKAGE DYNAMIQUE =====
const STORAGE = {
  data: "DATA_REPORT_" + currentSuffix,
  closures: "CLOSURES_REPORT_" + currentSuffix,
  reports: "REPORTS_REPORT_" + currentSuffix,
  locks: "LOCKS_REPORT_" + currentSuffix,
  annualDate: "ANNUAL_DATE_" + currentSuffix,
  specialDays: "SPECIAL_DAYS_" + currentSuffix,
  exerciseStart: "EXERCISE_START_" + currentSuffix
};

STORAGE.periodMeta = "PERIOD_META_REPORT_" + currentSuffix;

// ===== DONN√âES =====
let data = JSON.parse(localStorage.getItem(STORAGE.data)) || {};
let closures = JSON.parse(localStorage.getItem(STORAGE.closures)) || [];
let reports = JSON.parse(localStorage.getItem(STORAGE.reports)) || {};
let locks = JSON.parse(localStorage.getItem(STORAGE.locks)) || {};
let annualDate = localStorage.getItem(STORAGE.annualDate) || "";
let annualRate = Number(localStorage.getItem("ANNUAL_RATE")) || 10;
let specialDays = JSON.parse(localStorage.getItem(STORAGE.specialDays)) || {};
let exerciseStart = localStorage.getItem(STORAGE.exerciseStart) || "";
let periodMeta = JSON.parse(localStorage.getItem(STORAGE.periodMeta)) || {}

// OPTION : autoriser la r√©cup m√™me sans heures sup le m√™me jour
const ALLOW_RECUP_FREE = true;
const months=["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"]
const monthSelect=document.getElementById("monthSelect")
const yearSelect=document.getElementById("yearSelect")
const periodSelect=document.getElementById("periodSelect")
const calendar=document.getElementById("calendar")
const periodInfo=document.getElementById("periodInfo")
const totaux=document.getElementById("totaux")
const lockInfo = document.getElementById("lockInfo")
const popup = document.getElementById("popup")
const popupDate = document.getElementById("popupDate")
const manualExtra = document.getElementById("manualExtra")
const manualRecup = document.getElementById("manualRecup")
const isAbsent = document.getElementById("isAbsent")
const absentHours = document.getElementById("absentHours")

const popupJSON = document.getElementById("popupJSON")
const jsonTitle = document.getElementById("jsonTitle")
const jsonArea = document.getElementById("jsonArea")
  
let view=new Date()
let viewMonth=view.getMonth()
let viewYear=view.getFullYear()
let selectedDate=""
let currentPeriodIndex=0
// üîí Cl√© de date locale (√©vite les bugs UTC / changement d‚Äôann√©e)
function dateKeyLocal(d){
  const y = d.getFullYear()
  const m = String(d.getMonth() + 1).padStart(2, "0")
  const day = String(d.getDate()).padStart(2, "0")
  return `${y}-${m}-${day}`
}
function getBaseStartDate(){
  if(!exerciseStart){
    return null;
  }
  return new Date(exerciseStart);
}


function initSelectors(){
monthSelect.innerHTML=""
months.forEach((m,i)=>{
const o=document.createElement("option")
o.value=i;o.textContent=m
if(i===viewMonth)o.selected=true
monthSelect.appendChild(o)
})
yearSelect.innerHTML=""
for(let y=viewYear-2;y<=2050;y++){
const o=document.createElement("option")
o.value=y;o.textContent=y
if(y===viewYear)o.selected=true
yearSelect.appendChild(o)
}
}

function openClosures(){
const box=document.getElementById("closuresInputs")
box.innerHTML=""
for(let i=0;i<12;i++){
const input=document.createElement("input")
input.type="date"
input.value=closures[i]||""
box.appendChild(input)
}
document.getElementById("popupClosures").style.display="flex"
}

function closeClosures(){document.getElementById("popupClosures").style.display="none"}

function saveClosures(){
  const inputs = [...document.querySelectorAll("#closuresInputs input")]

  closures = inputs
    .map(i => i.value)
    .filter(v => v)
    .sort()

  localStorage.setItem(STORAGE.closures, JSON.stringify(closures))

  closures.forEach((_, i) => {
    if(reports[i] !== undefined){
      periodMeta[i] = { status: "modified" }
    }
  })

  localStorage.setItem(STORAGE.periodMeta, JSON.stringify(periodMeta))

  buildPeriods()
  closeClosures()
}
function deletePeriod(i){
  if(!confirm("‚ùå Supprimer cette p√©riode ? Elle sera ignor√©e mais conserv√©e.")) return;

  periodMeta[i] = { status: "deleted" }
  localStorage.setItem(STORAGE.periodMeta, JSON.stringify(periodMeta))
  update()
}
function buildPeriods(){
  const base = getBaseStartDate();
  if(!base) return;

  periodSelect.innerHTML = "";

  let start = new Date(base);
  let today = new Date();
  today.setHours(0,0,0,0);

  let foundIndex = null;

  closures.forEach((c, i) => {
    const end = new Date(c);
    end.setHours(0,0,0,0);

    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `${start.toLocaleDateString()} ‚Üí ${end.toLocaleDateString()}`;
    periodSelect.appendChild(opt);

    if (today >= start && today <= end) {
      foundIndex = i;
    }

    start = new Date(end);
    start.setDate(start.getDate() + 1);
  });

  // üëâ si aujourd‚Äôhui est apr√®s la derni√®re cl√¥ture
  if (foundIndex === null) {
    foundIndex = closures.length - 1;
  }

  currentPeriodIndex = foundIndex;
  periodSelect.selectedIndex = foundIndex;

  update();
}


function toggleLock(){
  const i=currentPeriodIndex
  locks[i]=!locks[i]
  localStorage.setItem(STORAGE.locks,JSON.stringify(locks))
  update()
}

function getCurrentPeriod(){
  let start = getBaseStartDate()

  for(let i = 0; i <= closures.length; i++){
    const end = i < closures.length ? new Date(closures[i]) : new Date(2099,11,31)
    if(i === currentPeriodIndex){
      return { start, end, index: i }
    }
    start = new Date(end)
    start.setDate(start.getDate() + 1)
  }
  return null
}

function generateCalendar(){
calendar.innerHTML=""
const firstDay = new Date(viewYear, viewMonth, 1).getDay()
const offset = firstDay === 0 ? 6 : firstDay - 1
const days=new Date(viewYear,viewMonth+1,0).getDate()
for(let i=0;i<offset;i++)calendar.appendChild(document.createElement("div"))
const period=getCurrentPeriod()
for(let d=1;d<=days;d++){
const key=`${viewYear}-${String(viewMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`
const div=document.createElement("div")
div.className="day"
if(period){
const dk=new Date(key)
if(dk>=period.start && dk<=period.end){div.classList.add("in-period")}
}
const day = data[key] || { extra:0, recup:0, absent:0 }
let html = `<strong>${d}</strong>`

if(day.extra){
  html += `<small style="color:#1976d2">+${day.extra}h</small>`
}

if(day.recup){
  html += `<small style="color:#ef6c00">-${day.recup}h</small>`
}

if(day.absent){
  if(specialDays[key] === "ferie"){
    html += `<small style="color:#0d47a1;font-weight:bold">üéå F√©ri√©</small>`
    div.style.background = "#e3f2fd"
    div.style.border = "2px dashed #1976d2"
  }else{
    html += `<small style="color:#c62828;font-weight:bold">ABS ${day.absent}h</small>`
    div.style.background = "#ffebee"
    div.style.border = "2px solid #c62828"
  }
}

div.innerHTML = html
if(key === dateKeyLocal(new Date()))
div.classList.add("today")
div.onclick=()=>openPopup(key)
calendar.appendChild(div)
}
}
function getLastValidReport(index) {
  for (let i = index - 1; i >= 0; i--) {
    if (reports[i] !== undefined && reports[i] !== null) {
      return Number(reports[i]) || 0;
    }
  }
  return 0;
}
function calculate(){
  let weeks = {}
  let absences = {}
  let totalRecup = 0
  let details = []
  let h25 = 0
  let h50 = 0

  const period = getCurrentPeriod()
  if(periodMeta[period.index]?.status === "deleted"){
  totaux.innerHTML = "<i>‚ùå Cette p√©riode est supprim√©e</i>"
  return
}

  // ‚úÖ CORRECTION IMAGE 4 : S√©curisation du reportPrev contre les valeurs NaN ou vides
const reportPrev = getLastValidReport(period.index);

  lockInfo.textContent = locks[period.index] ? "üîí P√©riode verrouill√©e" : "üîì P√©riode d√©verrouill√©e"
  periodInfo.innerHTML=`<b>P√©riode :</b> ${period.start.toLocaleDateString()} ‚Üí ${period.end.getFullYear()===2099?"en cours":period.end.toLocaleDateString()}<br>
  <b>Report pr√©c√©dent :</b> ${reportPrev.toFixed(2)} h`

// --- 1. TRAITEMENT DES DONN√âES (HEBDOMADAIRE) ---
Object.entries(data).forEach(([k, v]) => {
  const parts = k.split('-')
  const d = new Date(parts[0], parts[1] - 1, parts[2])

  if (limit && d <= limit) {
    const day = d.getDay() || 7
    const monday = new Date(d)
    if (day !== 1) monday.setDate(monday.getDate() - (day - 1))

    const key = dateKeyLocal(monday)
    weeks[key] = (weeks[key] || 0) + (v.extra || 0)
    absences[key] = (absences[key] || 0) + (v.absent || 0)
    totalRecup += v.recup || 0
  }
})

  // --- 2. CALCUL DES MAJORATIONS (R√àGLE D√âFINITIVE) ---
Object.entries(weeks).forEach(([week, extra]) => {
  const absent = absences[week] || 0;

  // Heures r√©ellement travaill√©es sur la semaine
  const base = Math.max(0, 35 - absent);
  const total = base + extra;

  let w25 = 0;
  let w50 = 0;

  // üîπ 25 % : d√®s qu'on d√©passe 35h jusqu'√† 43h inclus
  if (total > 35) {
    w25 = Math.min(total, 43) - 35;
  }

  // üîπ 50 % : d√®s qu'on d√©passe 43h
  if (total > 43) {
    w50 = total - 43;
  }

  // S√©curisation
  w25 = Math.max(0, w25);
  w50 = Math.max(0, w50);

  h25 += w25;
  h50 += w50;

  // (optionnel) d√©tail affichage
  const [y, m, d] = week.split("-");
  const weekDate = new Date(y, m - 1, d);
  details.push(
    `Semaine du ${weekDate.toLocaleDateString()} : ${w25.toFixed(2)}h √† 25% / ${w50.toFixed(2)}h √† 50%`
  );
});
    
    // ‚úÖ CORRECTION IMAGE 3 : Affichage sans bug UTC pour la date de 

  const brut25 = h25 * 1.25;
  const brut50 = h50 * 1.5;
  const brut = brut25 + brut50 + reportPrev;
  const net = brut - totalRecup;

  if(!locks[period.index]){
    reports[period.index] = net;
    localStorage.setItem(STORAGE.reports, JSON.stringify(reports));
  }

  // --- 3. AFFICHAGE HTML ---
  totaux.innerHTML = `
  <details class="calc-details">
    <summary>üìä D√©tails des calculs</summary>
    <div class="breakdown">
      ${details.join("<br>")}
      <hr>
      25% : ${h25}h √ó 1,25 = ${brut25.toFixed(2)} h<br>
      50% : ${h50}h √ó 1,50 = ${brut50.toFixed(2)} h<br>
      Report pr√©c√©dent : ${reportPrev.toFixed(2)} h
    </div>
  </details>
  <hr>
  <b>Solde brut :</b> ${brut.toFixed(2)} h<br>
  R√©cup : ${totalRecup.toFixed(2)} h<br>
  <b>Solde net :</b> ${net.toFixed(2)} h
  `;

  // --- 4. TAUX ET CL√îTURE (IMAGE 5 - Toujours avec 10‚Ç¨ par d√©faut) ---
  const rateContainer = document.getElementById("rateContainer");
  rateContainer.innerHTML = "";

  if (shouldShowAnnualClosure()) {
    rateContainer.innerHTML = `
      <div style="background:#fff3e0;padding:10px;border-radius:6px;border:1px solid #ff9800;margin-top:10px;">
        <label><b>Taux horaire (‚Ç¨)</b></label>
        <input type="number" id="hourlyRateInput" step="0.5"
        value="${annualRate}"
        oninput="annualRate = Number(this.value) || 10; localStorage.setItem('ANNUAL_RATE', annualRate); calculate()">
      </div>`;

    const rate = annualRate || 10;
    const paiement = net * rate;

    // R√©capitulatif absences/f√©ri√©s annuel
    let annAbsH = 0, annAbsD = 0, annFerH = 0, annFerD = 0;
    const limit = annualDate ? new Date(annualDate) : null;
    
    Object.entries(data).forEach(([date, v]) => {
      const parts = date.split('-');
      const d = new Date(parts[0], parts[1]-1, parts[2]);
      if (limit && d <= limit) {
        const abs = v.absent || 0;
        if(abs > 0){
          if(specialDays[date] === "ferie"){
            annFerD++; annFerH += abs;
          } else {
            annAbsH += abs;
            if(abs >= 7) annAbsD++;
          }
        }
      }
    });

    totaux.innerHTML += `
      <hr>
      <div style="background:#e8f5e9;padding:15px;border:2px solid #2e7d32;border-radius:8px;">
        <h3 style="margin:0;color:#2e7d32;">üéØ Cl√¥ture Annuelle</h3>
        <b>Paiement (${rate}‚Ç¨/h) :</b> ${paiement.toFixed(2)} ‚Ç¨
      </div>`;
  }
}

function openPopup(date){
  if(locks[currentPeriodIndex]){alert("üîí Cette p√©riode est verrouill√©e");return}

selectedDate=date
const d=data[date]||{extra:0,recup:0,absent:0}
popupDate.textContent=date
manualExtra.value=d.extra
manualRecup.value=d.recup
  absentHours.value=d.absent||0
  isAbsent.checked=(d.absent||0)>0
document.getElementById("popup").style.display="flex"
}

function closePopup(){document.getElementById("popup").style.display="none";update()}

function addExtra(h){
  if(!data[selectedDate]) data[selectedDate]={extra:0,recup:0}
  data[selectedDate].extra=Math.round((data[selectedDate].extra+h)*4)/4
  save();closePopup()
}

function addRecup(h){
  if(!data[selectedDate]) data[selectedDate]={extra:0,recup:0}
  const newVal = Math.round((data[selectedDate].recup+h)*4)/4
  data[selectedDate].recup = ALLOW_RECUP_FREE ? newVal : Math.min(newVal, data[selectedDate].extra)
  save();closePopup()
}

function saveManual(){
  const extra=Math.max(0,Number(manualExtra.value)||0)
  const recup=Math.max(0,Number(manualRecup.value)||0)
  const absent = isAbsent.checked ? Math.max(0,Number(absentHours.value)||0) : 0
  data[selectedDate]={
    extra:Math.round(extra*4)/4,
    recup: ALLOW_RECUP_FREE ? Math.round(recup*4)/4 : Math.min(Math.round(recup*4)/4, extra),
    absent:Math.round(absent*4)/4
  }
  save();closePopup()
}

function save(){ localStorage.setItem(STORAGE.data,JSON.stringify(data)) }

function isIOS(){return /iPad|iPhone|iPod/.test(navigator.userAgent)}

function exportJSON(){
  const payload = { data, closures, reports }
  const json = JSON.stringify(payload, null, 2)
  const blob = new Blob([json], { type: "application/json" })
  const filename = `heures_sup_${currentSuffix}.json`

  // üåç iOS + Android r√©cents ‚Üí feuille de partage
  if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename)] })) {
    const file = new File([blob], filename, { type: "application/json" })
    navigator.share({
      files: [file],
      title: "Sauvegarde heures suppl√©mentaires"
    })
    return
  }

  // üíª PC / Mac / anciens navigateurs ‚Üí t√©l√©chargement
  const url = URL.createObjectURL(blob)
  const a = document.createElement("a")
  a.href = url
  a.download = filename
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

function importJSON(){
if(isIOS()){
jsonTitle.textContent = "Collez le texte JSON (Import)"
jsonArea.value = ""
popupJSON.style.display = "flex"
}else{
const input = document.createElement("input")
input.type = "file"
input.accept = ".json"
input.onchange = e => {
const reader = new FileReader()
reader.onload = () => loadJSON(reader.result)
reader.readAsText(e.target.files[0])
}
input.click()
}
}

function confirmImportJSON(){loadJSON(jsonArea.value);closeJSONPopup()}

function loadJSON(text){
let obj
try{obj = JSON.parse(text)}catch(e){alert("‚ùå JSON invalide");return}
if(!obj.data||!obj.closures||!obj.reports){alert("‚ùå Format incorrect");return}
data=obj.data; closures=obj.closures; reports=obj.reports
localStorage.setItem(STORAGE.data,JSON.stringify(data))
localStorage.setItem(STORAGE.closures,JSON.stringify(closures))
localStorage.setItem(STORAGE.reports,JSON.stringify(reports))
buildPeriods(); update(); alert("‚úÖ Import r√©ussi")
}

function closeJSONPopup(){popupJSON.style.display = "none"}

function autoBackup(){
const key="AUTO_BACKUP_HS"
const last=localStorage.getItem(key)
const now=new Date().toISOString().slice(0,7)
if(last===now)return
const payload={data,closures,reports}
const blob=new Blob([JSON.stringify(payload)],{type:"application/json"})
const a=document.createElement("a")
a.href=URL.createObjectURL(blob)
a.download=`backup_heures_sup_${now}.json`
a.click()
localStorage.setItem(key,now)
}
async function importFeries(){
  const year = currentSuffix

  if(!confirm("Importer les jours f√©ri√©s officiels pour " + year + " ?")) return

  try{
    const res = await fetch(
      `https://calendrier.api.gouv.fr/jours-feries/metropole/${year}.json`
    )
    const feries = await res.json()

    Object.keys(feries).forEach(date=>{
      // ne pas √©craser une valeur existante
      if(!specialDays[date]){
        specialDays[date] = "ferie"
      }
      // cr√©er le jour seulement s‚Äôil n‚Äôexiste pas
if(!data[date]){
  data[date] = { extra:0, recup:0, absent:7 }
}
// sinon : ON NE TOUCHE √Ä RIEN
    })

    localStorage.setItem(STORAGE.specialDays, JSON.stringify(specialDays))
    localStorage.setItem(STORAGE.data, JSON.stringify(data))

    update()
    alert("‚úÖ Jours f√©ri√©s import√©s")
  }catch(e){
    alert("‚ùå Impossible d‚Äôimporter les jours f√©ri√©s")
  }
}
function update(){
  generateCalendar();
  calculate();
  autoBackup();
}

monthSelect.onchange=()=>{viewMonth=+monthSelect.value;generateCalendar()}
yearSelect.onchange=()=>{viewYear=+yearSelect.value;generateCalendar()}
periodSelect.onchange = () => {
  currentPeriodIndex = +periodSelect.value;
  update();
  showToast();
};


const annualDateInput = document.getElementById("annualDateInput");
annualDateInput.value = annualDate;
annualDateInput.onchange = ()=>{
  annualDate = annualDateInput.value;
  localStorage.setItem(STORAGE.annualDate, annualDate);
};
const exerciseStartInput = document.getElementById("exerciseStartInput");
exerciseStartInput.value = exerciseStart;

exerciseStartInput.onchange = ()=>{
  exerciseStart = exerciseStartInput.value;
  localStorage.setItem(STORAGE.exerciseStart, exerciseStart);
  buildPeriods();
};

  // ===== FONCTION DE V√âRIFICATION DU MOIS EXACT =====
function exportMonthlyPDF(){
  const { jsPDF } = window.jspdf
  const pdf = new jsPDF()

  const monthName = months[viewMonth]
  const title = `Heures suppl√©mentaires ‚Äì ${monthName} ${viewYear}`

  let y = 15
  pdf.setFontSize(14)
  pdf.text(title, 10, y)

  y += 10
  pdf.setFontSize(10)

  let totalExtra = 0
  let totalRecup = 0
  let totalAbs = 0
  Object.entries(data).forEach(([date, v])=>{
  const d = new Date(date)

  // uniquement le mois affich√©
  if(
    d.getFullYear() === viewYear &&
    d.getMonth() === viewMonth
  ){
    totalExtra += v.extra || 0
    totalRecup += v.recup || 0
    totalAbs += v.absent || 0
  }
})
  y += 5
  pdf.text(`Total heures sup : ${totalExtra.toFixed(2)} h`, 10, y)
  y += 6
  pdf.text(`Total r√©cup√©ration : ${totalRecup.toFixed(2)} h`, 10, y)
  y += 6
  pdf.text(`Total absences : ${totalAbs.toFixed(2)} h`, 10, y)

  pdf.save(`heures_sup_${monthName}_${viewYear}.pdf`)
}
function shouldShowAnnualClosure() {
  if (!annualDate) return false;

  const ad = new Date(annualDate);

  // afficher uniquement sur le mois de la cl√¥ture annuelle
  return (
    ad.getFullYear() === viewYear &&
    ad.getMonth() === viewMonth
  );
}
function showToast(){
  const toast = document.getElementById("toast")
  if(!toast) return

  toast.style.opacity = "1"
  setTimeout(() => {
    toast.style.opacity = "0"
  }, 3000)
}
initSelectors()
buildPeriods()
autoSwitchPeriodAtMidnight()

</script>
<div id="toast" style="
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#323232;
  color:#fff;
  padding:10px 16px;
  border-radius:20px;
  font-size:14px;
  opacity:0;
  pointer-events:none;
  transition:opacity .4s;
  z-index:9999;
">
  üïõ Nouvelle p√©riode activ√©e automatiquement
</div>
<div class="popup" id="popupClosures">
  <div class="popup-content">
    <h3>üìÖ Cl√¥tures comptables</h3>
    <div id="closuresInputs"></div>
    <button onclick="saveClosures()">Enregistrer</button>
    <button onclick="closeClosures()">Fermer</button>
  </div>
</div>
<p style="text-align:center; font-size:12px; color:#666; margin-top:30px;">
  ¬© Tous droits r√©serv√©s Chauvel Anthony
</p>
<div class="popup" id="popupYears">
  <div class="popup-content">
    <h3>üìÅ Exercices existants</h3>

    <div id="yearsList"></div>

    <hr>

    <label>Cr√©er / ouvrir un nouvel exercice</label>
    <input type="number" id="newYearInput" placeholder="Ex : 2039">

    <button onclick="confirmSwitchYear()">Ouvrir</button>
    <button onclick="closeYearsPopup()">Fermer</button>
  </div>
</div>
</body>
</html>